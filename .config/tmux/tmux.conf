# ============================================================================
# TERMINAL & COLORS
# ============================================================================

set -g default-terminal "tmux-256color"                 # enable 256 colors
set -ag terminal-overrides ",xterm-ghostty:RGB"         # true color for ghostty
set -ag terminal-overrides ",xterm-256color:RGB"        # true color fallback

# undercurl support (squiggly lines for nvim diagnostics)
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# ============================================================================
# NEOVIM COMPATIBILITY
# ============================================================================

set -sg escape-time 0                                   # no delay after pressing escape
set -g focus-events on                                  # pass focus events to nvim

# ============================================================================
# PREFIX KEY
# ============================================================================

unbind C-b                                              # remove default prefix
set -g prefix C-Space                                   # ctrl+space as new prefix
bind C-Space send-prefix                                # press twice to send literal

# ============================================================================
# WINDOWS & PANES
# ============================================================================

set -g base-index 1                                     # windows start at 1
set -g pane-base-index 1                                # panes start at 1
set-window-option -g pane-base-index 1
set -g renumber-windows on                              # renumber when window closed

# auto-name windows to current directory
set -g automatic-rename on
set -g automatic-rename-format '#{b:pane_current_path}'

# ============================================================================
# MOUSE
# ============================================================================

set -g mouse on                                         # enable mouse for resize/scroll

# ============================================================================
# COPY MODE (VIM STYLE)
# ============================================================================

set-window-option -g mode-keys vi                       # vim keys in copy mode
bind -T copy-mode-vi v send-keys -X begin-selection     # v to start selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"  # y copies to clipboard
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"  # mouse copies too
bind p run "pbpaste | tmux load-buffer - && tmux paste-buffer"     # prefix+p pastes from clipboard

# ============================================================================
# SPLITS & NAVIGATION
# ============================================================================

# intuitive split keys (in current directory)
bind | split-window -h -c "#{pane_current_path}"        # prefix+| for vertical split
bind - split-window -v -c "#{pane_current_path}"        # prefix+- for horizontal split
unbind '"'
unbind %

bind c new-window -c "#{pane_current_path}"             # new window in current dir

# vim-style pane navigation (prefix+hjkl)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# resize panes (prefix+ctrl+hjkl, repeatable)
bind -r C-h resize-pane -L 5
bind -r C-j resize-pane -D 5
bind -r C-k resize-pane -U 5
bind -r C-l resize-pane -R 5

# ============================================================================
# SESSIONS
# ============================================================================

# fzf session switcher popup
bind s display-popup -E "tmux list-sessions -F '#{session_name}' | fzf --reverse --header='Switch session' | xargs -I {} tmux switch-client -t {}"

bind S command-prompt -p "New session:" "new-session -s '%%'"  # prefix+S to create named session
bind X confirm-before -p "Kill #S? (y/n)" "run-shell 'tmux switch-client -n; tmux kill-session -t #S'"  # prefix+X to kill session

# ============================================================================
# CONFIG RELOAD
# ============================================================================

bind r source-file ~/.config/tmux/tmux.conf \; display "Config reloaded"

# ============================================================================
# STATUS BAR
# ============================================================================

set -g status-position top                              # bar at top of screen
set -g status-left ""                                   # clean left side
set -g status-right-length 100
set -g status-right "#{E:@catppuccin_status_directory}#{E:@catppuccin_status_session}"

# ============================================================================
# PLUGINS (managed by TPM)
# ============================================================================

set -g @plugin 'tmux-plugins/tpm'                       # plugin manager
set -g @plugin 'tmux-plugins/tmux-sensible'             # sensible defaults
set -g @plugin 'christoomey/vim-tmux-navigator'         # ctrl+hjkl between nvim/tmux
set -g @plugin 'tmux-plugins/tmux-resurrect'            # save/restore sessions
set -g @plugin 'tmux-plugins/tmux-continuum'            # auto-save sessions
set -g @plugin 'catppuccin/tmux#v2.1.3'                 # catppuccin theme

# ============================================================================
# PLUGIN CONFIG
# ============================================================================

# session persistence
set -g @resurrect-capture-pane-contents 'on'            # save pane contents
set -g @continuum-restore 'on'                          # auto-restore on start

# catppuccin theme
set -g @catppuccin_flavor "mocha"                       # dark theme
set -g @catppuccin_window_status_style "rounded"        # rounded window tabs
set -g @catppuccin_window_text " #W"                   # window name with icon
set -g @catppuccin_window_current_text " #W"           # current window
set -g @catppuccin_window_flags "icon"                  # show window flags as icons

# ============================================================================
# INITIALIZE TPM (keep at bottom)
# ============================================================================

run '~/.config/tmux/plugins/tpm/tpm'
